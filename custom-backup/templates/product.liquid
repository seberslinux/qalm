{% comment %}
  Product template
{% endcomment %}

<div class="product-page">
  <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Product Images -->
      <div class="product-images">
        {% if product.featured_media %}
          <div class="main-image mb-4">
            <img 
              src="{{ product.featured_media | image_url: width: 600 }}" 
              alt="{{ product.featured_media.alt | default: product.title }}"
              class="w-full h-auto"
              id="main-image"
            >
          </div>
        {% endif %}
        
        {% if product.media.size > 1 %}
          <div class="thumbnail-images flex gap-2">
            {% for media in product.media limit: 4 %}
              <button 
                class="thumbnail-btn {% if forloop.first %}active{% endif %}"
                data-image="{{ media | image_url: width: 600 }}"
                data-alt="{{ media.alt | default: product.title }}"
              >
                <img 
                  src="{{ media | image_url: width: 100 }}" 
                  alt="{{ media.alt | default: product.title }}"
                  class="w-20 h-20 object-cover"
                >
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      
      <!-- Product Info -->
      <div class="product-info">
        <h1 class="text-3xl font-light mb-4">{{ product.title }}</h1>
        
        <div class="price mb-6">
          {% if product.price_varies %}
            <span class="text-2xl">From {{ product.price_min | money }}</span>
          {% else %}
            <span class="text-2xl">{{ product.price | money }}</span>
          {% endif %}
          
          {% if product.compare_at_price > product.price %}
            <span class="text-lg text-gray-500 line-through ml-2">
              {{ product.compare_at_price | money }}
            </span>
          {% endif %}
        </div>
        
        {% if product.description != blank %}
          <div class="description mb-6">
            {{ product.description }}
          </div>
        {% endif %}
        
        <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" class="product-form">
          {% unless product.has_only_default_variant %}
            <div class="variants mb-6">
              {% for option in product.options_with_values %}
                <div class="variant-option mb-4">
                  <label class="block text-sm font-medium mb-2">{{ option.name }}</label>
                  <div class="flex gap-2">
                    {% for value in option.values %}
                      <label class="variant-option-item">
                        <input 
                          type="radio" 
                          name="options[{{ option.name }}]" 
                          value="{{ value }}"
                          {% if forloop.first %}checked{% endif %}
                          class="sr-only"
                        >
                        <span class="variant-option-text">{{ value }}</span>
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endunless %}
          
          <div class="quantity mb-6">
            <label for="quantity" class="block text-sm font-medium mb-2">Quantity</label>
            <input 
              type="number" 
              id="quantity" 
              name="quantity" 
              value="1" 
              min="1" 
              class="w-20 px-3 py-2 border border-gray-300"
            >
          </div>
          
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          
          <button 
            type="submit" 
            name="add" 
            class="w-full bg-black text-white py-3 px-6 text-sm uppercase tracking-wider hover:bg-gray-800 transition-colors"
            {% unless product.available %}disabled{% endunless %}
          >
            {% if product.available %}
              Add to Cart
            {% else %}
              Sold Out
            {% endif %}
          </button>
        </form>
        
        {% if product.metafields.custom.sensory_features %}
          <div class="sensory-features mt-8">
            <h3 class="text-lg font-medium mb-4">Sensory-Friendly Features</h3>
            <ul class="space-y-2">
              {% for feature in product.metafields.custom.sensory_features.value %}
                <li class="flex items-center">
                  <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  {{ feature }}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
.thumbnail-btn {
  border: 2px solid transparent;
  padding: 2px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.thumbnail-btn.active,
.thumbnail-btn:hover {
  border-color: #000;
}

.variant-option-item {
  display: inline-block;
  cursor: pointer;
}

.variant-option-text {
  display: inline-block;
  padding: 8px 16px;
  border: 1px solid #d1d5db;
  transition: all 0.2s;
}

.variant-option-item input:checked + .variant-option-text {
  background-color: #000;
  color: #fff;
  border-color: #000;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Thumbnail image switching
  const thumbnailBtns = document.querySelectorAll('.thumbnail-btn');
  const mainImage = document.getElementById('main-image');
  
  thumbnailBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all thumbnails
      thumbnailBtns.forEach(b => b.classList.remove('active'));
      // Add active class to clicked thumbnail
      this.classList.add('active');
      // Update main image
      if (mainImage) {
        mainImage.src = this.dataset.image;
        mainImage.alt = this.dataset.alt;
      }
    });
  });
  
  // Variant selection
  const variantInputs = document.querySelectorAll('input[name^="options"]');
  const addToCartForm = document.querySelector('.product-form');
  
  variantInputs.forEach(input => {
    input.addEventListener('change', function() {
      // Update variant ID based on selected options
      updateVariantId();
    });
  });
  
  function updateVariantId() {
    const selectedOptions = {};
    variantInputs.forEach(input => {
      if (input.checked) {
        const optionName = input.name.match(/\[(.*?)\]/)[1];
        selectedOptions[optionName] = input.value;
      }
    });
    
    // Find matching variant
    const variants = {{ product.variants | json }};
    const selectedVariant = variants.find(variant => {
      return Object.keys(selectedOptions).every(optionName => {
        return variant.options.includes(selectedOptions[optionName]);
      });
    });
    
    if (selectedVariant) {
      const variantIdInput = addToCartForm.querySelector('input[name="id"]');
      if (variantIdInput) {
        variantIdInput.value = selectedVariant.id;
      }
    }
  }
});
</script>
